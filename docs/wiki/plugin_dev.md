# bkci流水线插件开发规范

---

## 插件定义规范

- 插件描述类基本信息通过线上流程定义
    - 插件工作台新增插件时，可指定标识、名称、开发语言
        - 标识、开发语言初始化之后不能再更改
    - 上架/升级插件时，可更新插件基本信息，包括名称、分类、描述等信息
    <br/>

- 插件执行、输入、输出相关定义，通过插件代码库中名为task.json的文件定义
    - task.json存储在插件代码库根路径下
    - 详见[插件配置规范](plugin_config.md)

## 插件开发规范

- 插件封装为命令行可执行命令：
    - 调起命令由task.json的`execution.target`字段指定
        - execution.target格式为字符串
        - 调起命令中可以使用${var_name}的方式获取变量
    - 若调起执行前需安装依赖，安装命令由task.json的`execution.demands`字段指定
        - execution.demands为列表，可配置多个安装命令
        - 安装命令可以使用${var_name}的方式获取变量
<br/>

- 插件输入字段值，从指定的输入文件中获取
    - 输入信息文件名，由环境变量`bk_data_input`指定
    - 输入信息文件存放路径，由环境变量`bk_data_dir`指定
    - 输入信息文件内容为json，示例如下：
    ```
    {
        "inputVar_1": "value1",
        "inputVar_2": "value2"
    }
    ```
    - 使用SDK进行开发时，无需关注输入文件位置和命名，使用SDK提供的方法获取输入即可
<br/>

- 插件输出信息通过写文件的方式通知bkci agent
    - 输出信息文件名，由环境变量`bk_data_output`指定
    - 输出信息文件存放路径，由环境变量`bk_data_dir`指定
    - 输出信息文件格式，详见[插件输出规范](plugin_output.md)
    - 使用SDK进行开发时，无需关注输出文件位置和名称，使用SDK提供的方法设置输出即可
<br/>

- 插件执行结果将由两个策略判定：
    - 若输出信息文件中指定了`status`字段，则以该字段值为准
    - 若未指定输出信息文件，则以插件执行命令返回值为准
        - 返回值为0，标识成功
        - 返回值非0，标识失败
<br/>

- 插件日志输出到控制台

    - bkci agent将收集控制台日志展示到流水线前台


## 插件帮助文档（详细描述）规范

---

- 目的
    - 方便用户了解插件工作原理和适用范围
    - 方便用户遇到问题时自助获取解决方案
<br/>

- 提供方式
    - 发布插件时，填写在插件详细描述字段
    - 将展示在插件市场查看插件详情界面，或执行日志查看帮助。
<br/>

- 使用文档**使用markdown语言**撰写，建议包含如下内容：

### 1、插件介绍

- 简要说明插件功能

### 2、插件适用场景

- 详细描述插件适用场景

### 3、插件使用限制和受限解决方案

- [可选]调用频率限制
- [可选]并发限制
- [可选]网络限制，说明网络要求，或者需申请的网络策略
- [可选]若插件使用有权限控制（IP、用户等），需详细描述申请方式

### 4、插件常见的失败原因和解决方案

- 列举可能的失败原因、错误码，针对场景给出解决方案，方便用户快速解决问题

## 插件新增/发布流程

---

### 插件状态流转图
![](assets/status.png)

### 流程描述

- 开发者在插件工作台新增插件
- 开发者本地开发调试插件
    - 本地开发调试
- 开发者调试OK后，在插件工作台新增版本，启动发布流程
- 提交版本后：
    - 进入测试阶段
        - 开发者可以在新增插件时选择的调试项目下，创建测试流水线，判断插件是否符合预期
        - 测试过程中，若发现问题，可修复代码bug后重新打成包，再重新传包后继续测试
    - 测试OK后，开发者点【继续】确认，则成功发布版本
